#!/usr/bin/env php
<?php

/*
 * This file is part of the RegexParser package.
 *
 * (c) Younes ENNAJI <younes.ennaji.pro@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

require __DIR__.'/../vendor/autoload.php';

use RegexParser\Exception\LexerException;
use RegexParser\Exception\ParserException;
use RegexParser\NodeVisitor\CompilerNodeVisitor;
use RegexParser\NodeVisitor\ValidatorNodeVisitor;
use RegexParser\Regex;

if ($argc < 2) {
    echo "Usage: php bin/regex-parser '/your_regex_here/flags'\n";
    exit(1);
}

$regex = $argv[1];

try {
    $regexService = Regex::create(); // Instantiate the Regex facade

    // 1. Parsing (Regex facade handles Lexer and Parser internally)
    $ast = $regexService->parse($regex);

    // 2. Validation
    $validator = new ValidatorNodeVisitor();
    $ast->accept($validator);
    echo "Validation: OK\n";

    // 3. Recompilation
    $compiler = new CompilerNodeVisitor();
    $compiled = $ast->accept($compiler);

    echo "Parsed successfully!\n";
    echo 'Original:   '.$regex."\n";
    echo 'Recompiled: '.$compiled."\n";
} catch (LexerException|ParserException $e) {
    echo 'Error: '.$e->getMessage()."\n";
    exit(1);
}
