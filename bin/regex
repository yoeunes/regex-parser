#!/usr/bin/env php
<?php

declare(strict_types=1);

/*
 * This file is part of the RegexParser package.
 *
 * (c) Younes ENNAJI <younes.ennaji.pro@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

require __DIR__.'/../vendor/autoload.php';

use RegexParser\Exception\LexerException;
use RegexParser\Exception\ParserException;
use RegexParser\Regex;

function showHelp(): void
{
    echo "Regex Parser CLI Tool\n\n";
    echo "Usage: regex <command> [options] <pattern>\n\n";
    echo "Commands:\n";
    echo "  parse <pattern> [--validate]    Parse and recompile a regex pattern\n";
    echo "  analyze <pattern>               Analyze a regex (parse, validate, ReDoS, explain)\n";
    echo "  highlight <pattern> [--format=auto|cli|html]  Highlight regex for display\n";
    echo "  validate <pattern>              Validate a regex pattern\n";
    echo "  help                            Show this help\n\n";
    echo "Examples:\n";
    echo "  regex parse '/a+/'\n";
    echo "  regex analyze '/a+/'\n";
    echo "  regex highlight '/a+/' --format=cli\n";
    echo "  regex validate '/a+/'\n";
}

if ($argc < 2) {
    showHelp();
    exit(1);
}

$command = $argv[1];

switch ($command) {
    case 'help':
    case '--help':
    case '-h':
        showHelp();
        exit(0);

    case 'parse':
        if ($argc < 3) {
            echo "Error: Missing pattern\n";
            echo "Usage: regex parse <pattern> [--validate]\n";
            exit(1);
        }
        $pattern = $argv[2];
        $validate = in_array('--validate', $argv, true);
        $regex = Regex::create();

        try {
            $ast = $regex->parse($pattern);
            $compiled = $ast->accept(new RegexParser\NodeVisitor\CompilerNodeVisitor());

            echo "Parsed successfully!\n";
            echo "Original:   {$pattern}\n";
            echo "Recompiled: {$compiled}\n";

            if ($validate) {
                $validation = $regex->validate($pattern);
                echo "Validation: " . ($validation->isValid ? 'OK' : 'INVALID') . "\n";
                if (!$validation->isValid && $validation->error) {
                    echo "Error: {$validation->error}\n";
                }
            }
        } catch (LexerException|ParserException $e) {
            echo "Error: {$e->getMessage()}\n";
            exit(1);
        }
        break;

    case 'analyze':
        if ($argc < 3) {
            echo "Error: Missing pattern\n";
            echo "Usage: regex analyze <pattern>\n";
            exit(1);
        }
        $pattern = $argv[2];
        $regex = Regex::create();

        try {
            $ast = $regex->parse($pattern);
            $validation = $regex->validate($pattern);
            $analysis = $regex->analyzeReDoS($pattern);
            $explain = $regex->explain($pattern);

            echo "Pattern: {$pattern}\n";
            echo "Parse: OK\n";
            echo "Validation: " . ($validation->isValid ? 'OK' : 'INVALID') . "\n";
            if (!$validation->isValid && $validation->error) {
                echo "Error: {$validation->error}\n";
            }
            echo "ReDoS severity: {$analysis->severity->value}\n";
            echo "ReDoS score: {$analysis->score}\n";
            if ($analysis->error) {
                echo "ReDoS error: {$analysis->error}\n";
            }
            echo "\nExplanation:\n";
            echo $explain . "\n";
        } catch (LexerException|ParserException $e) {
            echo "Error: {$e->getMessage()}\n";
            exit(1);
        }
        break;

    case 'highlight':
        if ($argc < 3) {
            echo "Error: Missing pattern\n";
            echo "Usage: regex highlight <pattern> [--format=auto|cli|html]\n";
            exit(1);
        }
        $pattern = $argv[2];
        $format = 'auto';
        foreach ($argv as $arg) {
            if (str_starts_with($arg, '--format=')) {
                $format = substr($arg, 9);
            }
        }
        $regex = Regex::create();

        try {
            if ($format === 'html') {
                $highlighted = $regex->highlightHtml($pattern);
            } elseif ($format === 'cli') {
                $highlighted = $regex->highlightCli($pattern);
            } else {
                $highlighted = $regex->highlight($pattern);
            }

            echo $highlighted . "\n";
        } catch (LexerException|ParserException $e) {
            echo "Error: {$e->getMessage()}\n";
            exit(1);
        }
        break;

    case 'validate':
        if ($argc < 3) {
            echo "Error: Missing pattern\n";
            echo "Usage: regex validate <pattern>\n";
            exit(1);
        }
        $pattern = $argv[2];
        $regex = Regex::create();

        $validation = $regex->validate($pattern);
        echo ($validation->isValid ? 'OK' : 'INVALID') . "\n";
        if (!$validation->isValid && $validation->error) {
            echo "Error: {$validation->error}\n";
            exit(1);
        }
        break;

    default:
        echo "Unknown command: {$command}\n\n";
        showHelp();
        exit(1);
}