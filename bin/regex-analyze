#!/usr/bin/env php
<?php

declare(strict_types=1);

/*
 * This file is part of the RegexParser package.
 *
 * (c) Younes ENNAJI <younes.ennaji.pro@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

require __DIR__.'/../vendor/autoload.php';

use RegexParser\Exception\LexerException;
use RegexParser\Exception\ParserException;
use RegexParser\Regex;

if ($argc < 2) {
    fwrite(STDERR, "Usage: regex-analyze '/pattern/flags'\n");
    exit(1);
}

$pattern = $argv[1];
$regex = Regex::create();

try {
    $ast = $regex->parse($pattern);
    $validation = $regex->validate($pattern);
    $analysis = $regex->analyzeReDoS($pattern);
    $explain = $regex->explain($pattern);

    echo "Pattern: {$pattern}\n";
    echo "Parse: OK\n";
    echo "Validation: ".($validation->isValid ? 'OK' : 'INVALID')."\n";
    if (!$validation->isValid && null !== $validation->error) {
        echo "Error: {$validation->error}\n";
    }
    echo "ReDoS severity: {$analysis->severity->value}\n";
    echo "ReDoS score: {$analysis->score}\n";
    if ($analysis->error) {
        echo "ReDoS error: {$analysis->error}\n";
    }
    echo "\nExplanation:\n";
    echo $explain."\n";
} catch (LexerException|ParserException $e) {
    fwrite(STDERR, "Error: {$e->getMessage()}\n");
    exit(1);
}
