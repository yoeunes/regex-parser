version: 3

tasks:
    phpcs:
        cmds:
            - cmd: tools/php-cs-fixer/vendor/bin/php-cs-fixer fix --diff -v {{.CLI_ARGS}}
            - cmd: touch .task/phpcs.success
        sources:
            - .php-cs-fixer.dist.php
            - bin/**/*.php
            - src/**/*.php
            - tests/**/*.php
            - benchmarks/**/*.php
        excludes:
            - tests/Fixtures/**/*
        generates:
            - .cache/php-cs-fixer/cache.json
            - .task/phpcs.success
        method: checksum

    phplint:
        cmds:
            - cmd: tools/phplint/vendor/bin/phplint {{.CLI_ARGS}}
            - cmd: touch .task/phplint.success
        sources:
            - .phplint.yml
            - bin/**/*.php
            - src/**/*.php
            - tests/**/*.php
            - benchmarks/**/*.php
        excludes:
            - tests/Fixtures/**/*
        generates:
            - .cache/phplint/*
            - .task/phplint.success
        method: checksum

    phpstan:
        cmds:
            - cmd: tools/phpstan/vendor/bin/phpstan analyse {{.CLI_ARGS}}
            - cmd: touch .task/phpstan.success
        sources:
            - phpstan.dist.neon
            - phpstan-baseline.neon
            - extension.neon
            - bin/**/*.php
            - src/**/*.php
            - tests/**/*.php
            - benchmarks/**/*.php
        generates:
            - .cache/phpstan/*
            - .task/phpstan.success
        method: checksum

    rector:
        cmds:
            - cmd: tools/rector/vendor/bin/rector process {{.CLI_ARGS}}
            - cmd: touch .task/rector.success
        sources:
            - rector.php
            - bin/**/*.php
            - src/**/*.php
            - tests/**/*.php
        generates:
            - .cache/rector/*
            - .task/rector.success
        method: checksum

    phpunit:
        cmds:
            - cmd: vendor/bin/phpunit {{.CLI_ARGS}}
            - cmd: touch .task/phpunit.success
        sources:
            - phpunit.dist.xml
            - src/**/*.php
            - tests/**/*.php
        generates:
            - .cache/phpunit/test-results
            - .task/phpunit.success
        method: checksum

    phpbench:
        cmds:
            - cmd: tools/phpbench/vendor/bin/phpbench run tests/Benchmark --report=default {{.CLI_ARGS}}
            - cmd: touch .task/phpbench.success
        sources:
            - phpbench.json
            - phpbench.yml
            - src/**/*.php
            - tests/Benchmark/**/*.php
        generates:
          - .task/phpbench.success
        method: checksum

    coverage:
        cmds:
            - cmd: vendor/bin/phpunit --coverage-html coverage {{.CLI_ARGS}}
            - cmd: touch .task/coverage.success
        sources:
            - phpunit.dist.xml
            - src/**/*.php
            - tests/**/*.php
        generates:
            - coverage
            - .task/phpbench.success
        method: checksum

    lint:
        deps:
            - install
        cmds:
            - task: rector
            - task: phpcs
            - task: phplint
            - task: phpunit
            - task: phpstan

    install:
        cmds:
            - composer install
            - composer install -d tools/php-cs-fixer
            - composer install -d tools/phpbench
            - composer install -d tools/phplint
            - composer install -d tools/phpstan
            - composer install -d tools/rector

            - task: link
        sources:
            - ./composer.json
            - ./composer.lock
            - ./tools/**/composer.json
            - ./tools/**/composer.lock
        generates:
            - ./vendor/autoload.php
            - ./tools/**/vendor/autoload.php

    update:
        cmds:
            - composer update -W
            - composer outdated --direct
            - composer audit || true

            - composer update -W -d tools/php-cs-fixer
            - composer outdated --direct -d tools/php-cs-fixer
            - composer audit -d tools/php-cs-fixer || true

            - composer update -W -d tools/phpbench
            - composer outdated --direct -d tools/phpbench
            - composer audit -d tools/phpbench || true

            - composer update -W -d tools/phplint
            - composer outdated --direct -d tools/phplint
            - composer audit -d tools/phplint || true

            - composer update -W -d tools/phpstan
            - composer outdated --direct -d tools/phpstan
            - composer audit -d tools/phpstan || true

            - composer update -W -d tools/rector
            - composer outdated --direct -d tools/rector
            - composer audit -d tools/rector || true

            - task: link

    link:
        cmds:
            - ln -sf ../../tools/php-cs-fixer/vendor/bin/php-cs-fixer ./vendor/bin/php-cs-fixer
            - ln -sf ../tools/php-cs-fixer/vendor/bin/php-cs-fixer ./bin/php-cs-fixer
            - ln -sf ../tools/php-cs-fixer/vendor/bin/php-cs-fixer ./bin/phpcs

            - ln -sf ../../tools/phpbench/vendor/bin/phpbench ./vendor/bin/phpbench
            - ln -sf ../tools/phpbench/vendor/bin/phpbench ./bin/phpbench

            - ln -sf ../../tools/phplint/vendor/bin/phplint ./vendor/bin/phplint
            - ln -sf ../tools/phplint/vendor/bin/phplint ./bin/phplint

            - ln -sf ../tools/phpstan/vendor/bin/phpstan ./bin/phpstan

            - ln -sf ../../tools/rector/vendor/bin/rector ./vendor/bin/rector
            - ln -sf ../tools/rector/vendor/bin/rector ./bin/rector
