{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{% block toolbar %}
    {% set total = collector.total %}
    {% set invalid = collector.invalid %}
    {% set icon_color = invalid ? 'red' : (total ? 'green' : 'gray') %}
    {% set text_color = invalid ? 'red' : 'default' %}

    {% set icon %}
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-diagram-3" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H11a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 5 7h2.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM3 11.5A1.5 1.5 0 0 1 4.5 10h1A1.5 1.5 0 0 1 7 11.5v1A1.5 1.5 0 0 1 5.5 14h-1A1.5 1.5 0 0 1 3 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5A1.5 1.5 0 0 1 10.5 10h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 9 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/>
        </svg>
        <span class="sf-toolbar-value {{ text_color }}">{{ total }}</span>
    {% endset %}

    {% set text %}
        <div class="sf-toolbar-info-piece">
            <b>Regex Patterns</b>
            <span class="sf-toolbar-status {{ total ? '' : 'sf-toolbar-status-gray' }}">{{ total }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Invalid / ReDoS</b>
            <span class="sf-toolbar-status {{ invalid ? 'sf-toolbar-status-red' : (total ? 'sf-toolbar-status-green' : 'sf-toolbar-status-gray') }}">{{ invalid }}</span>
        </div>
    {% endset %}

    {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', { link: profiler_url, status: icon_color }) }}
{% endblock %}

{% block menu %}
    <span class="label {{ collector.invalid ? 'label-status-error' : (collector.total ? 'label-status-success' : 'label-status-disabled') }}">
        <span class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                 <path fill-rule="evenodd" d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H11a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 5 7h2.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM3 11.5A1.5 1.5 0 0 1 4.5 10h1A1.5 1.5 0 0 1 7 11.5v1A1.5 1.5 0 0 1 5.5 14h-1A1.5 1.5 0 0 1 3 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5A1.5 1.5 0 0 1 10.5 10h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1A1.5 1.5 0 0 1 9 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/>
            </svg>
        </span>
        <strong>Regex</strong>
        {% if collector.invalid > 0 %}
            <span class="count">
                <span>{{ collector.total }}</span>
                <span class="status-error">{{ collector.invalid }}</span>
            </span>
        {% else %}
             <span class="count">{{ collector.total }}</span>
        {% endif %}
    </span>
{% endblock %}

{% block panel %}
    <h2>Regex Parser</h2>

    {% if collector.total == 0 %}
        <div class="empty">
            <p>No regular expressions were collected for this request.</p>
        </div>
    {% else %}
        <div class="metrics">
            <div class="metric">
                <span class="value">{{ collector.total }}</span>
                <span class="label">Total Patterns</span>
            </div>
            <div class="metric {{ collector.invalid ? 'status-error' : 'status-success' }}">
                <span class="value">{{ collector.invalid }}</span>
                <span class="label">Invalid / ReDoS</span>
            </div>
        </div>

        {% for regex in collector.regexes %}
            {% set validation = regex.validation %}
            {% set score_color = 'green' %}
            {% if regex.score > 50 %}
                {% set score_color = 'yellow' %}
            {% endif %}
            {% if regex.score > 100 %}
                {% set score_color = 'red' %}
            {% endif %}

            <div class="card {{ not validation.isValid ? 'card-error' : '' }}">
                <div class="card-title">
                    <span class="font-normal">{{ regex.source }}</span>
                    <span class="text-muted">Complexity Score: <span class="badge status-{{ score_color }}">{{ regex.score }}</span></span>
                </div>

                <div class="card-body">
                    <div class="regex-pattern">{{ regex.pattern }}</div>

                    {% if not validation.isValid %}
                        <div class="call-error">
                            <span class="badge status-error">Validation Error</span>
                            {{ validation.error }}
                        </div>
                    {% endif %}

                    {% if regex.subject is not null %}
                        <div class="regex-subject">
                            <strong>Subject:</strong>
                            <span class="badge {{ regex.match_result ? 'status-success' : 'status-error' }}">
                                {{ regex.match_result ? 'Match' : 'No Match' }}
                            </span>
                            <pre><code>{{ regex.subject }}</code></pre>
                        </div>
                    {% endif %}

                    <h4>Explanation</h4>
                    <div class="regex-explain">
                        <pre>{{ regex.explanation }}</pre>
                    </div>
                </div>
            </div>
        {% endfor %}

    {% endif %}
{% endblock %}
