# FIX KNOWN LIMITATIONS IN REGEX-PARSER: TARGETED IMPROVEMENTS

You have 3 known limitations to fix. Create comprehensive test suites for each, identify root causes, apply minimal fixes, and verify all tests pass. This is your only task - complete it fully before providing final summary.

## LIMITATION 1: ReDoS DETECTION - FALSE POSITIVES/NEGATIVES

### Create File: tests/Integration/ReDoSEdgeCasesTest.php
Build 15+ test patterns with assertions:

FALSE POSITIVES (should NOT be detected as ReDoS):
- `/a+b/` - simple quantifier, no backtracking
- `/[a-z]+test/` - character class with literal
- `/(a|b)+c/` - alternation with fixed followup
- `/test\d+end/` - digit quantifier with literals
- `/(a{2,5})+/` - nested quantifiers with limits
- `/^[a-z]*$/` - anchored, can't cause catastrophic backtrack
- `/(abc)+def/` - fixed string alternation

FALSE NEGATIVES (SHOULD be detected as ReDoS - catastrophic backtracking risk):
- `/(a+)+b/` - nested quantifiers without limits
- `/(a*)*b/` - nested quantifiers
- `/(a|a)*/` - redundant alternation with quantifier
- `/(?:a+)+b/` - non-capturing nested
- `/(a|ab)+/` - overlapping alternation
- `/(a*|b*)+/` - alternative quantifiers nested
- `/(x+x+)+y/` - double nested quantifiers

Run: `./vendor/bin/phpunit tests/Integration/ReDoSEdgeCasesTest.php`
Expected: ALL PASS (100%)

If failures occur:
1. Find root cause in `src/ReDoS/ReDoSAnalyzer.php` severity calculation
2. Check `src/ReDoS/PatternAnalyzer.php` for quantifier detection logic
3. Verify `isNestedQuantifier()` and `isRedundantAlternation()` methods
4. Apply minimal fix to improve detection accuracy
5. Re-run tests until all pass

## LIMITATION 2: BACKREFERENCE COMPILATION - EDGE CASES

### Create File: tests/Integration/BackreferenceEdgeCasesTest.php
Build 20+ test patterns for round-trip compilation:

BASIC BACKREFERENCES:
- `/(a)\1/` - simple backreference
- `/(\d\d)\1/` - digit pair repeat
- `/(test)\1/` - word backreference
- `/([a-z]+)\1/` - class with backreference
- `/(.)\1/` - any char backreference

MULTIPLE BACKREFERENCES:
- `/(a)(b)\1\2/` - forward references
- `/(a)(b)(c)\3\2\1/` - reverse order
- `/(a)(b)\2(c)\1/` - mixed order
- `/(test)(\w+)\2\1/` - complex pattern

NAMED BACKREFERENCES:
- `/(?P<x>a)(?P=x)/` - named group
- `/(?P<first>[a-z]+)(?P=first)/` - named with class
- `/(?P<x>[0-9])(?P=x)(?P=x)/` - repeated named reference

COMPLEX PATTERNS:
- `/((?:a+)+)\1/` - nested group with backreference
- `/(?:(a)\1)+/` - backreference in repeated group
- `/(a|b)(a|b)\1\2/` - alternation with references
- `/(\(?\d{3}\)?)?\1/` - optional group backreference

For EACH pattern:
- Parse: `Regex::parse($pattern)`
- Compile: `$compiled = $regex->compile()`
- Compare: `assert($pattern === $compiled)` (round-trip equality)
- Check: No exceptions thrown

Run: `./vendor/bin/phpunit tests/Integration/BackreferenceEdgeCasesTest.php`
Expected: ALL PASS (100%)

If failures occur:
1. Find which patterns fail the round-trip test
2. Check `src/Node/Backreference.php` compilation logic
3. Verify `src/Visitor/CompileVisitor.php` backreference handling
4. Ensure group numbering aligns in parsing and compilation
5. Apply minimal fix and re-test

## LIMITATION 3: LOOKBEHIND VALIDATION - FIXED vs VARIABLE LENGTH

### Create File: tests/Integration/LookbehindEdgeCasesTest.php
Build 25+ test patterns with exception handling:

FIXED-LENGTH LOOKBEHINDS (VALID - should parse without exception):
- `/(?<=foo)bar/` - fixed literal
- `/(?<=\d{3})test/` - fixed quantifier
- `/(?<=\(\d{2}\))/` - fixed escaped chars
- `/(?<=[a-z]{5})/` - fixed length class
- `/(?<=\w\d)/` - fixed char sequence
- `/(?<=test\.)pattern/` - fixed literal with escape
- `/(?<=\\)/` - fixed backslash
- `/(?<=[A-Z])/` - single char class

VARIABLE-LENGTH LOOKBEHINDS (INVALID - should throw exception):
- `/(?<=a*)b/` - zero or more
- `/(?<=a+)b/` - one or more
- `/(?<=a?)b/` - zero or one
- `/(?<=a{1,})b/` - variable range
- `/(?<=[a-z]*)test/` - class with *
- `/(?<=\d+)end/` - digit with +
- `/(?<=(a|b))c/` - alternation
- `/(?<=(test)*)/` - group with *

MIXED/COMPLEX:
- `/(?<=\d{3}a+)/` - fixed + variable (should fail)
- `/(?<=[a]{3}b*)/` - literal repeat + variable (should fail)
- `/(?<=(?:test)?)/` - optional group (should fail)
- `/(?<=\w{0,5})/` - variable range (should fail)
- `/(?<!a+)/` - negative lookbehind with + (should fail)

For FIXED patterns:
- `Regex::parse($pattern)` should NOT throw exception
- Pattern should compile successfully

For VARIABLE patterns:
- `Regex::parse($pattern)` should throw InvalidRegexException OR UnsupportedSyntaxException
- Catch exception and verify error message contains "lookbehind"

Run: `./vendor/bin/phpunit tests/Integration/LookbehindEdgeCasesTest.php`
Expected: ALL PASS (100%)

If failures occur:
1. Find which patterns fail (fixed parsed as variable or vice versa)
2. Check `src/Parser/LookbehindParser.php` for length validation
3. Review `src/Node/LookbehindAssertion.php` logic
4. Verify `isFixedLength()` calculation in quantifier handling
5. Apply minimal fix and re-test

## EXECUTION SEQUENCE

1. Create all 3 test files (ReDoS, Backreference, Lookbehind)
2. Run each test suite individually
3. If any fail: identify root cause → apply minimal fix → re-run
4. When all 3 pass 100%: create IMPROVEMENTS.md documenting:
   - Which limitations were fixed
   - Root cause identified for each
   - Code changes applied (file + line numbers)
   - Test results (X/X passing)
5. Update VALIDATION_REPORT.md:
   - Change known limitations from "❓" to "✅" Fixed
   - Add "Limitation Fixes" section with dates
6. Commit all changes with message: "Fix 3 known limitations: ReDoS detection, backreferences, lookbehinds"

## SUCCESS CRITERIA

✅ ReDoSEdgeCasesTest.php: 100% pass rate
✅ BackreferenceEdgeCasesTest.php: 100% pass rate
✅ LookbehindEdgeCasesTest.php: 100% pass rate
✅ No regressions in existing 140+ tests
✅ IMPROVEMENTS.md created with detailed findings
✅ VALIDATION_REPORT.md updated
✅ Git commit with changes

Do NOT stop until all criteria are met. This is a single-pass task - complete it fully.